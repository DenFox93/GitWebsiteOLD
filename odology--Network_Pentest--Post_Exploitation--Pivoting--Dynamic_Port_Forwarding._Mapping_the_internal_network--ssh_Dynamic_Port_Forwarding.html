<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ssh Dynamic Port Forwarding</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>ssh Dynamic Port Forwarding</h1><br/><br /><strong><h3>Requirements:</h3></strong><br />• SSH server installed on pivot host<br />• Connectivity to SSH port (22) on the pivot host with credentials for user@pivotSystem<br /><br /><strong><h3>1. establish dynamic port forward</h3></strong><br />   ◇ <strong>SSH dynamic port forwarding </strong><br />    SSH dynamic port forwarding via SOCKS (Socket Secure) allows arbitrary connections to be proxied to a remote host. Any application that can use a SOCKS can receive and transmit data through the tunnel.<br />    It listens on a local port established when the connection is set up. Anything sent to the local port is forwarded through the SSH tunnel<br />    We have to run this command from the attacker machine against the pivot(exploited?) machine. If the user is an administrator will ask us a password<br />    <div class="codebox"><div class="codebox"><span style="color:#ff9d00;font-weight:700">ssh</span>&nbsp;-D&nbsp;&lt;AttackerLoopbackIP&gt;<span style="color:#ff9d00;font-weight:700">:</span>&lt;AttackerPort&gt;&nbsp;-f&nbsp;-N&nbsp;user@&lt;IPpivotSystem&gt;</div></div><br />        –f → tells SSH to run in the background <br />        –N →  tells SSH not to run a remote command <br />    <span style="color:#a5452a;">example:</span><br />       <div class="codebox"><div class="codebox"><span style="color:#ff9d00;font-weight:700">ssh</span>&nbsp;-N&nbsp;-D&nbsp;127.0.0.1<span style="color:#ff9d00;font-weight:700">:</span>1080&nbsp;user@192.168.1.125</div></div><br /><br />        <br /><strong><h3>2. Set the SOCKS proxy settings</h3></strong><br /><h3>    ◇ </h3><strong><h3>Enable proxy settings for Linux application with proxychains</h3></strong><h3> </h3><br />        Linux applications that don&#39;t have the capability to support a proxy can be forced to proxy with a tool called &quot;proxychains&quot;.<br />        Proxychains works by replacing standard libraries (via LD_PRELOAD) to trick the application into communication though the proxy.<br />        The port used by proxychains is set in the <span style="text-decoration:underline;">/etc/proxychains.conf</span> file; the default is TCP/9050. Change it to 1080<br />        <a href=""><img src="images/778-1.png" alt="images/778-1.png" /></a><br />        if we wnat to use burpsuite as proxy add to proxychains.conf:<br />        <div class="codebox"><div class="codebox"><span style="color:#0088ff;font-weight:400">#burpsuite</span><br />http&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#333333;font-weight:400">127.0</span>.<span style="color:#333333;font-weight:400">0.1</span>&nbsp;<span style="color:#333333;font-weight:400">8080</span><br />https&nbsp;&nbsp;&nbsp;<span style="color:#333333;font-weight:400">127.0</span>.<span style="color:#333333;font-weight:400">0.1</span>&nbsp;<span style="color:#333333;font-weight:400">8080</span></div></div><br />            <strong>To use with python3 scripts </strong><br />            see also: <a href="https://blog.ropnop.com/proxying-cli-tools/">https://blog.ropnop.com/proxying-cli-tools/</a><br />            convert from .der to .crt → The DER format is simply a binary form of a certificate instead of the ASCII PEM format. It sometimes has a file extension of .der but it often has a file extension of .crt so the only way to tell the difference between a DER .crt file and a PEM .crt file is to open it in a text editor and look for the BEGIN/END statements. <br />            <div class="codebox"><div class="codebox">openssl&nbsp;x509&nbsp;<span style="color:#ff9d00;font-weight:700">-</span>inform&nbsp;DER&nbsp;<span style="color:#ff9d00;font-weight:700">-in</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Downloads<span style="color:#ff9d00;font-weight:700">/</span>cacert.der&nbsp;<span style="color:#ff9d00;font-weight:700">-</span>out&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Downloads<span style="color:#ff9d00;font-weight:700">/</span>cacert.crt<br />python3&nbsp;<span style="color:#ff9d00;font-weight:700">-</span>c&nbsp;<span style="color:#3ad900;font-weight:400">&quot;import&nbsp;certifi;&nbsp;print(certifi.where())&quot;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#from&nbsp;which&nbsp;file&nbsp;python3&nbsp;load&nbsp;certificate&nbsp;for&nbsp;SSL</span><br /><span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Downloads<span style="color:#ff9d00;font-weight:700">/</span>cacert.crt&nbsp;&gt;&gt;&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>ssl<span style="color:#ff9d00;font-weight:700">/</span>certs<span style="color:#ff9d00;font-weight:700">/</span><span style="color:#00117f;font-weight:400">ca-certificates</span>.crt</div></div><br />        If the port set with SSH and proxychains.conf match(in our example we have to change it to 1080), you can send traffic from non-proxy aware-applications through the tunnel like this:<br />        <div class="codebox"><div class="codebox">proxychains&nbsp;&lt;command&nbsp;of&nbsp;the&nbsp;application&nbsp;and&nbsp;its&nbsp;options&gt;</div></div><br />        <span style="color:#a5452a;">examples:</span><br />        <div class="codebox"><div class="codebox">proxychains&nbsp;nmap&nbsp;-n&nbsp;-sT&nbsp;-Pn&nbsp;-p&nbsp;&lt;ports&gt;&nbsp;&lt;otherTargetIP&gt;</div></div><br />        <div class="codebox"><div class="codebox">proxychains&nbsp;python3&nbsp;GitDorker.py&nbsp;<span style="color:#ff9d00;font-weight:700">-</span>tf&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>GitDorker<span style="color:#ff9d00;font-weight:700">/</span>tokens.txt&nbsp;<span style="color:#ff9d00;font-weight:700">-</span>org&nbsp;tesla&nbsp;<span style="color:#ff9d00;font-weight:700">-</span>d&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>GitDorker<span style="color:#ff9d00;font-weight:700">/</span>Dorks<span style="color:#ff9d00;font-weight:700">/</span>alldorks.txt</div></div><br /><h3>   ◇ </h3><strong><h3>Enable proxy settings for Metasploit</h3></strong><br />        We have set the exploit and the payload for the TargetIP<br />        <div class="codebox"><div class="codebox">msf&nbsp;&gt;&nbsp;use&nbsp;&lt;exploit&gt;<br />msf&nbsp;&gt;&nbsp;<span style="color:#ff9d00;font-weight:700">set</span>&nbsp;RHOST&nbsp;&lt;TargetIP&gt;<br />msf&nbsp;&gt;&nbsp;<span style="color:#ff9d00;font-weight:700">set</span>&nbsp;RPORT&nbsp;&lt;TargetPort&gt;<br />msf&nbsp;&gt;&nbsp;<span style="color:#ff9d00;font-weight:700">set</span>&nbsp;Proxies&nbsp;socks4<span style="color:#ff9d00;font-weight:700">:</span>127.0.0.1<span style="color:#ff9d00;font-weight:700">:</span>1080<br />msf&nbsp;&gt;&nbsp;<span style="color:#ff9d00;font-weight:700">set</span>&nbsp;ReverseAllowProxy&nbsp;<span style="color:#ff9d00;font-weight:700">true</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#tells&nbsp;Metasploit&nbsp;that&nbsp;the&nbsp;reverse&nbsp;connection&nbsp;will&nbsp;be&nbsp;outside&nbsp;of&nbsp;the&nbsp;proxy.</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#in&nbsp;fact&nbsp;how&nbsp;you&nbsp;can&nbsp;see&nbsp;we&nbsp;do&nbsp;not&nbsp;have&nbsp;used&nbsp;the&nbsp;reverse_tcp&nbsp;payload</span></div></div><br /><h3>   ◇ </h3><strong><h3>Enable proxy settings for the Browser</h3></strong><strong>(not so useful for now..)</strong><br />    <a href=""><img src="images/778-2.png" alt="images/778-2.png" /></a><br />        We can use them to mirror the results obtained from a webserver only accessible from the pivotSystem and not from the outside. <br />       Browsers can be configured to use SOCKS proxy (do not confuse with the HTTP proxy settings is a different proxy technology with a different protocol)<br />       The settings to configure SOCKS proxy can be found usually under preferences &gt; network tab &gt; configuration settings<br />        host: &lt;AttackerLoopbackIP&gt; and port: &lt;AttackerPort&gt; <br /><h3>   </h3><br />Bibliography:<br />• <a href="https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot">https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot</a><br />• <a href="https://zaiste.net/posts/ssh-port-forwarding/">https://zaiste.net/posts/ssh-port-forwarding/</a><br />• <a href="https://pen-testing.sans.org/resources/papers/gwapt/tunneling-pivoting-web-application-penetration-testing-120229">https://pen-testing.sans.org/resources/papers/gwapt/tunneling-pivoting-web-application-penetration-testing-120229</a><br /><br />#burpsuite<br />http	127.0.0.1 8080<br />https	127.0.0.1 8080<br />     </div>
</body>
</html>
